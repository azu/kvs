name: Release

on:
  pull_request:
    branches:
      - master
    types: [closed]

jobs:
  # Job 1: Check if release is needed (read-only)
  check:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      EXISTS_TAG: ${{ steps.tag_check.outputs.EXISTS_TAG }}
    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'release/')
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false

      - name: Set PACKAGE_VERSION
        run: echo "PACKAGE_VERSION=$(cat lerna.json | jq -r .version)" >> $GITHUB_ENV

      - name: Tag Check
        id: tag_check
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${PACKAGE_VERSION}$"; then
            echo "EXISTS_TAG=true" >> $GITHUB_OUTPUT
          else
            echo "EXISTS_TAG=false" >> $GITHUB_OUTPUT
          fi
        env:
          PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}

  # Job 2: Perform release (minimal permissions)
  release:
    runs-on: ubuntu-latest
    needs: check
    if: always() && (needs.check.outputs.EXISTS_TAG == 'false')
    environment:
      name: npm
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      release-url: ${{ steps.create_release.outputs.release-url }}
      released: ${{ steps.create_release.outputs.released }}
    permissions:
      contents: write
      id-token: write # Required for OIDC authentication
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          # Release workflow should not use cache for avoiding cache poisoning
          # https://docs.zizmor.sh/audits/#cache-poisoning
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Git Identity
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set PACKAGE_VERSION
        id: set_version
        run: |
          VERSION=$(cat lerna.json | jq -r .version)
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install
        run: yarn install

      - name: Build
        run: yarn run build

      - name: Publish
        run: yarn run ci:release
        env:
          # OIDC authentication for npm publishing
          # https://docs.npmjs.com/generating-provenance-statements
          NPM_CONFIG_PROVENANCE: true
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Git Tag
        run: |
          git tag "v${PACKAGE_VERSION}"
          git push origin "v${PACKAGE_VERSION}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}

      - name: Create Release
        id: create_release
        run: |
          RELEASE_URL=$(gh release create "v${PACKAGE_VERSION}" \
            --title "${GITHUB_EVENT_PULL_REQUEST_TITLE}" \
            --notes "${GITHUB_EVENT_PULL_REQUEST_BODY}" \
            --json url -q .url)
          echo "release-url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
          GITHUB_EVENT_PULL_REQUEST_TITLE: ${{ github.event.pull_request.title }}
          GITHUB_EVENT_PULL_REQUEST_BODY: ${{ github.event.pull_request.body }}

  # Job 3: Comment on PR (write-only)
  comment:
    needs: release
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.release.result != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment on PR - Success
        if: needs.release.result == 'success'
        run: |
          gh pr comment "$PR_NUMBER" \
            --repo "$REPOSITORY" \
            --body "Release v$VERSION completed successfully!

          - GitHub Release: $RELEASE_URL
          - Workflow run: $SERVER_URL/$REPOSITORY/actions/runs/$RUN_ID"
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VERSION: ${{ needs.release.outputs.version }}
          RELEASE_URL: ${{ needs.release.outputs.release-url }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}

      - name: Comment on PR - Failure
        if: needs.release.result == 'failure'
        run: |
          gh pr comment "$PR_NUMBER" \
            --repo "$REPOSITORY" \
            --body "Release failed

          Please check the workflow logs for details.
          Workflow run: $SERVER_URL/$REPOSITORY/actions/runs/$RUN_ID"
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
